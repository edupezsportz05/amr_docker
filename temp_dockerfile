FROM ubuntu:24.04

# Avoid interactive prompts during package install
ENV DEBIAN_FRONTEND=noninteractive

# Set up environment variables for ROS
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Create non-root user
ARG USERNAME=amr
ARG UID=2500
ARG GID=2500

# Update system and install basic tools
RUN apt update && apt upgrade -y && \
    apt install -y sudo curl wget nano gnupg2 lsb-release openssh-server python3 python3-pip locales git \
    && locale-gen en_US en_US.23333UTF-8 && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8

# Create user and grant sudo
RUN groupadd --gid $GID $USERNAME && \
    useradd --uid $UID --gid $GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install ROS 2 Jazzy
RUN apt update && \
    apt upgrade -y && \
    apt install -y software-properties-common && \
    add-apt-repository universe && \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - && \
    sh -c 'echo "deb http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list' && \
    apt update && \
    apt install -y ros-jazzy-desktop && \
    echo "source /opt/ros/jazzy/setup.bash" >> /etc/bash.bashrc 

#install Colcon
RUN apt install -y install python3-colcon-common-extensions

# SSH config
RUN mkdir /var/run/sshd
RUN echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
RUN echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config

# Set password for user
RUN echo "$USERNAME:robotlab" | chpasswd

# Switch to the user
USER $USERNAME

# Source ROS 2 setup in user bashrc
RUN echo "source /opt/ros/jazzy/setup.bash" >> /home/$USERNAME/.bashrc

# Set workdir
WORKDIR /home/$USERNAME

#git clone
RUN git clone https://github.com/sahana-arulanandam/amr-prototype.git

#install rosmaster driver 
RUN cd ~/amr-prototype/py_install && \
    sudo  python3 setup.py install
    
RUN echo "source ~/amr-prototype/driver_ws/setup.bash" >> /home/$USERNAME/.bashrc && \
    echo "source ~/amr-prototype/icarus_ws/setup.bash" >> /home/$USERNAME/.bashrc

RUN source ~/.bashrc
